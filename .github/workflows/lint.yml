name: üßº Lint

on:
  workflow_dispatch:
    inputs:
      frameworks:
        description: 'Frameworks to lint (comma-separated, see frameworks.json for available options)'
        required: false
        default: 'all'
        type: string
  pull_request:
    branches: [ main, master, dev ]
    paths:
      - 'apps/**'
      - 'eslint.config.js'
      - 'package.json'
      - '.github/workflows/lint.yml'
    types: [ opened, synchronize, reopened ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  setup:
    name: Setup for Linting
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      frameworks: ${{ steps.matrix.outputs.frameworks }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Determine frameworks to lint
        id: matrix
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.frameworks }}" != "all" ]; then
            frameworks="${{ github.event.inputs.frameworks }}"
          else
            # Get framework list from centralized config
            frameworks=$(node scripts/setup/generate-scripts.js github)
          fi
          echo "frameworks=$(echo "[$frameworks]" | sed 's/,/", "/g' | sed 's/\[/[\"/ ; s/\]/\"]/')" >> $GITHUB_OUTPUT
          echo "Linting frameworks: $frameworks"

  lint:
    name: Lint ${{ matrix.framework }}
    needs: setup
    if: fromJSON(needs.setup.outputs.frameworks)[0] != ''
    runs-on: ubuntu-latest
    timeout-minutes: 10
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        framework: ${{ fromJSON(needs.setup.outputs.frameworks) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run ESLint for ${{ matrix.framework }}
        run: npm run lint:${{ matrix.framework }}
        
      - name: Generate lint report for ${{ matrix.framework }}
        if: always()
        run: |
          mkdir -p lint-reports
          npm run lint:${{ matrix.framework }} -- --format=json --output-file=lint-reports/${{ matrix.framework }}-lint-report.json || true
          
      - name: Upload lint report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-report-${{ matrix.framework }}
          path: lint-reports/${{ matrix.framework }}-lint-report.json
          retention-days: 30

  summary:
    name: Lint Summary
    needs: [setup, lint]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Download all lint reports
        uses: actions/download-artifact@v4
        with:
          path: lint-reports
          merge-multiple: true
          
      - name: Generate lint summary
        run: |
          echo "## üßº Lint Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Framework | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          
          total_apps=0
          passed_apps=0
          
          # Get the frameworks that were actually tested
          frameworks=$(echo '${{ needs.setup.outputs.frameworks }}' | jq -r '.[]' | tr '\n' ' ')
          
          for framework in $frameworks; do
            total_apps=$((total_apps + 1))
            report_file="lint-reports/${framework}-lint-report.json"
            
            if [ -f "$report_file" ]; then
              error_count=$(jq '[.[] | select(.errorCount > 0)] | length' "$report_file" 2>/dev/null || echo "0")
              warning_count=$(jq '[.[] | select(.warningCount > 0)] | length' "$report_file" 2>/dev/null || echo "0")
              
              if [ "$error_count" = "0" ]; then
                echo "| $framework | ‚úÖ No errors |" >> $GITHUB_STEP_SUMMARY
                passed_apps=$((passed_apps + 1))
              else
                echo "| $framework | ‚ùå $error_count errors, $warning_count warnings |" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "| $framework | ‚ùì Report not found |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Overall Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Passed**: $passed_apps/$total_apps frameworks" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          
      - name: Check overall status
        run: |
          if [[ "${{ needs.lint.result }}" != "success" ]]; then
            echo "‚ùå Some linting failed"
            exit 1
          else
            echo "‚úÖ All linting passed successfully!"
          fi