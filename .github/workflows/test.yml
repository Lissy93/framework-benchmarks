name: 🧪 Test

on:
  workflow_dispatch:
    inputs:
      frameworks:
        description: 'Frameworks to test (comma-separated, see frameworks.json for available options)'
        required: false
        default: 'all'
        type: string
  pull_request:
    branches: [ main, dev ]
    types: [ opened, synchronize, reopened ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  setup:
    name: Setup and Sync Assets
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      frameworks: ${{ steps.matrix.outputs.frameworks }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: package-lock.json
          
      - name: Install root dependencies
        run: |
          npm ci
          npm run install:playwright
          
      - name: Sync shared assets
        run: npm run sync-assets
        
      - name: Install framework dependencies
        run: |
          set -e  # Exit on error
          # Install dependencies for each framework app
          for app in apps/*/; do
            if [ -f "$app/package.json" ]; then
              echo "Installing dependencies for $(basename "$app")"
              cd "$app"
              npm i || { echo "Failed to install dependencies for $(basename "$app")"; exit 1; }
              cd - > /dev/null
            fi
          done
          
      - name: Cache node_modules and Playwright browsers
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            apps/*/node_modules
            ~/.cache/ms-playwright
          key: ${{ runner.os }}-node-modules-playwright-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-playwright-
            ${{ runner.os }}-node-modules-
            
      - name: Determine frameworks to test
        id: matrix
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.frameworks }}" != "all" ]; then
            frameworks="${{ github.event.inputs.frameworks }}"
          else
            # Get framework list from centralized config
            frameworks=$(node scripts/setup/generate-scripts.js github)
          fi
          echo "frameworks=$(echo "[$frameworks]" | sed 's/,/", "/g' | sed 's/\[/[\"/ ; s/\]/\"]/')" >> $GITHUB_OUTPUT
          echo "Testing frameworks: $frameworks"

  test:
    name: Test ${{ matrix.framework }}
    needs: setup
    if: fromJSON(needs.setup.outputs.frameworks)[0] != ''
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        framework: ${{ fromJSON(needs.setup.outputs.frameworks) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Restore dependencies cache
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            apps/*/node_modules
            ~/.cache/ms-playwright
          key: ${{ runner.os }}-node-modules-playwright-${{ hashFiles('**/package-lock.json') }}
          
      - name: Install Playwright browsers (if cache miss)
        run: |
          if [ ! -d ~/.cache/ms-playwright ]; then
            echo "Playwright cache miss - installing browsers"
            npm run install:playwright
          else
            echo "Playwright cache hit - skipping browser installation"
          fi
          
      - name: Run tests for ${{ matrix.framework }}
        id: test-run
        uses: nick-fields/retry@v2
        with:
          timeout_minutes: 10
          max_attempts: 4
          retry_wait_seconds: 30
          command: |
            echo "🧪 Running ${{ matrix.framework }} tests (attempt ${{ github.run_attempt }})"
            npm run test:${{ matrix.framework }} -- --reporter=github
            
      - name: Create result file
        if: always()
        run: |
          mkdir -p test-status
          if [[ "${{ steps.test-run.outcome }}" == "success" ]]; then
            echo "passed" > test-status/${{ matrix.framework }}.txt
          else
            echo "failed" > test-status/${{ matrix.framework }}.txt
          fi
            
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.framework }}-test-results
          path: |
            playwright-report/
            test-results/
          retention-days: 30
          
      - name: Upload test status
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.framework }}-status
          path: test-status/${{ matrix.framework }}.txt
          retention-days: 1

  summary:
    name: Test Summary
    needs: [setup, test]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Download all test status artifacts
        if: always()
        uses: actions/download-artifact@v4
        with:
          pattern: "*-status"
          merge-multiple: true
          
      - name: Generate test summary
        run: |
          echo "## 🧪 Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Framework | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          
          # Get frameworks that were tested
          frameworks="${{ needs.setup.outputs.frameworks }}"
          frameworks_array=($(echo "$frameworks" | tr -d '[]"' | tr ',' '\n' | xargs))
          
          # Check result of each framework based on status files
          failed_count=0
          passed_count=0
          total_count=${#frameworks_array[@]}
          
          for framework in "${frameworks_array[@]}"; do
            if [[ -f "${framework}.txt" ]]; then
              status=$(cat "${framework}.txt")
              if [[ "$status" == "passed" ]]; then
                echo "| ${framework} | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
                ((passed_count++))
              else
                echo "| ${framework} | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
                ((failed_count++))
              fi
            else
              echo "| ${framework} | ⚠️  No result |" >> $GITHUB_STEP_SUMMARY
              ((failed_count++))
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📊 Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Total frameworks**: $total_count" >> $GITHUB_STEP_SUMMARY
          echo "- **Passed**: $passed_count" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed**: $failed_count" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📊 Workflow Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Actor**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          
          # Set environment variable for final status check
          echo "FAILED_COUNT=$failed_count" >> $GITHUB_ENV
          echo "PASSED_COUNT=$passed_count" >> $GITHUB_ENV
          
      - name: Check overall status
        run: |
          echo "📊 Final Results:"
          echo "   ✅ Passed: $PASSED_COUNT"
          echo "   ❌ Failed: $FAILED_COUNT"
          
          if [[ "$FAILED_COUNT" -gt 0 ]]; then
            echo ""
            echo "❌ Some framework tests failed."
            echo "ℹ️  This is expected behavior - the workflow continues even when individual frameworks fail."
            echo "📋 Check the summary above for detailed results."
            # Don't exit 1 here since we want the workflow to show as successful
            # if it completed (even with some framework failures)
          else
            echo ""
            echo "✅ All framework tests passed successfully. Party time! 🎉"
          fi
